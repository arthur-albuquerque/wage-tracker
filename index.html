<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wage Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .tab-content { margin-top: 20px; }
        .source-card { margin-bottom: 15px; }
        .shift-list { max-height: 200px; overflow-y: auto; }
        .total-wage { font-weight: bold; color: #007bff; }
        .month-actions { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Wage Tracker</h1>
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addMonthModal">Add Month</button>
        <button class="btn btn-success mb-3" onclick="downloadJSON()">Download JSON</button>
        
        <!-- Nav Tabs for Months -->
        <ul class="nav nav-tabs" id="monthTabs" role="tablist"></ul>
        <div class="tab-content" id="monthTabContent"></div>
    </div>

    <!-- Add Month Modal -->
    <div class="modal fade" id="addMonthModal" tabindex="-1" aria-labelledby="addMonthModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMonthModalLabel">Add Month</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="monthYear" class="form-label">Month (YYYY-MM)</label>
                        <input type="month" class="form-control" id="monthYear" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMonth()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Source Modal -->
    <div class="modal fade" id="addSourceModal" tabindex="-1" aria-labelledby="addSourceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSourceModalLabel">Add Source</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="sourceInputs">
                        <div class="mb-3">
                            <label for="sourceName1" class="form-label">Source Name</label>
                            <input type="text" class="form-control source-name" id="sourceName1" placeholder="e.g., Hospital A" required>
                        </div>
                        <div class="mb-3">
                            <label for="baseWage1" class="form-label">Base Wage (BRL)</label>
                            <input type="number" class="form-control base-wage" id="baseWage1" step="0.01" min="0" required>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addSourceInput()">Add Another Source</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSources()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Shift Modal -->
    <div class="modal fade" id="addShiftModal" tabindex="-1" aria-labelledby="addShiftModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addShiftModalLabel">Add Shift</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="shiftSource" class="form-label">Wage Source</label>
                        <select class="form-control" id="shiftSource"></select>
                    </div>
                    <div class="mb-3">
                        <label for="shiftDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="shiftDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="shiftAmount" class="form-label">Amount (BRL)</label>
                        <input type="number" class="form-control" id="shiftAmount" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="shiftType" class="form-label">Shift Type</label>
                        <select class="form-control" id="shiftType">
                            <option value="extra">Extra Shift (Increases Wage)</option>
                            <option value="given">Given Shift (Decreases Wage)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveShift()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let wageData = JSON.parse(localStorage.getItem('wageData')) || {};

        function addSourceInput(count = 1) {
            const sourceInputs = document.getElementById('sourceInputs');
            const existingInputs = sourceInputs.querySelectorAll('.source-input').length;
            count = existingInputs + 1;
            const div = document.createElement('div');
            div.className = 'source-input mb-3';
            div.innerHTML = `
                <label for="sourceName${count}" class="form-label">Source Name</label>
                <input type="text" class="form-control source-name" id="sourceName${count}" placeholder="e.g., Hospital A" required>
                <label for="baseWage${count}" class="form-label">Base Wage (BRL)</label>
                <input type="number" class="form-control base-wage" id="baseWage${count}" step="0.01" min="0" required>
            `;
            sourceInputs.appendChild(div);
        }

        function saveMonth() {
            alert('Save clicked'); // Immediate feedback
            const monthYear = document.getElementById('monthYear').value;
            console.log('Attempting to save month:', monthYear);
            if (!monthYear) {
                alert('Please select a month.');
                return;
            }
            if (wageData[monthYear]) {
                alert('Month already exists.');
                return;
            }

            wageData[monthYear] = [];
            console.log('Month saved successfully:', monthYear);
            saveData();
            renderTabs();
            const newTab = new bootstrap.Tab(document.querySelector(`#${monthYear}-tab`));
            if (newTab) newTab.show(); // Force show the new tab
            bootstrap.Modal.getInstance(document.getElementById('addMonthModal')).hide();
        }

        function saveSources() {
            const monthYear = document.getElementById('addSourceModal').dataset.month;
            if (!monthYear) return alert('No active month selected.');

            const sources = [];
            const sourceInputs = document.querySelectorAll('#sourceInputs .source-input');
            for (let input of sourceInputs) {
                const name = input.querySelector('.source-name').value.trim();
                const wage = parseFloat(input.querySelector('.base-wage').value);
                if (name && !isNaN(wage)) {
                    sources.push({ name, baseWage: wage, shifts: [] });
                }
            }
            if (sources.length === 0) return alert('Please add at least one valid source.');

            wageData[monthYear] = sources;
            console.log('Sources saved:', monthYear, sources);
            saveData();
            renderTabs();
            bootstrap.Modal.getInstance(document.getElementById('addSourceModal')).hide();
            document.getElementById('sourceInputs').innerHTML = `
                <div class="mb-3">
                    <label for="sourceName1" class="form-label">Source Name</label>
                    <input type="text" class="form-control source-name" id="sourceName1" placeholder="e.g., Hospital A" required>
                </div>
                <div class="mb-3">
                    <label for="baseWage1" class="form-label">Base Wage (BRL)</label>
                    <input type="number" class="form-control base-wage" id="baseWage1" step="0.01" min="0" required>
                </div>
            `;
        }

        function saveShift() {
            const monthYear = document.getElementById('addShiftModal').dataset.month;
            const sourceName = document.getElementById('shiftSource').value;
            const date = document.getElementById('shiftDate').value;
            const amount = parseFloat(document.getElementById('shiftAmount').value);
            const isExtra = document.getElementById('shiftType').value === 'extra';
            
            if (!date || isNaN(amount)) return alert('Please fill in all fields correctly.');

            const monthData = wageData[monthYear];
            if (!monthData) return alert('Month data not found.');

            const source = monthData.find(s => s.name === sourceName);
            if (source) {
                source.shifts.push({ date, amount, isExtra });
                console.log('Shift saved:', { monthYear, sourceName, date, amount, isExtra });
                saveData();
                renderTabs();
                bootstrap.Modal.getInstance(document.getElementById('addShiftModal')).hide();
            } else {
                console.error('Source not found:', sourceName);
            }
        }

        function deleteShift(monthYear, sourceName, shiftIndex) {
            const monthData = wageData[monthYear];
            if (!monthData) return console.error('Month not found:', monthYear);

            const source = monthData.find(s => s.name === sourceName);
            if (source) {
                source.shifts.splice(shiftIndex, 1);
                console.log('Shift deleted:', { monthYear, sourceName, shiftIndex });
                saveData();
                renderTabs();
            } else {
                console.error('Source not found:', sourceName);
            }
        }

        function deleteMonth(monthYear) {
            if (confirm(`Are you sure you want to delete the month ${monthYear}? This action cannot be undone.`)) {
                delete wageData[monthYear];
                console.log('Month deleted:', monthYear);
                saveData();
                renderTabs();
            }
        }

        function downloadJSON() {
            const dataStr = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(wageData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute('href', dataStr);
            downloadAnchorNode.setAttribute('download', 'wage_data.json');
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function saveData() {
            localStorage.setItem('wageData', JSON.stringify(wageData));
            console.log('Saved data:', wageData);
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&")
                .replace(/</g, "<")
                .replace(/>/g, ">")
                .replace(/"/g, """)
                .replace(/'/g, "'");
        }

        function renderTabs() {
            try {
                const tabs = document.getElementById('monthTabs');
                const content = document.getElementById('monthTabContent');
                if (!tabs || !content) throw new Error('Tab or content element not found');

                tabs.innerHTML = '';
                content.innerHTML = '';

                const months = Object.keys(wageData).sort().reverse();
                if (months.length === 0) {
                    content.innerHTML = '<p>No months added yet.</p>';
                    return;
                }

                months.forEach((month, index) => {
                    const isActive = index === 0 ? 'active' : '';
                    const isShow = index === 0 ? 'show' : '';
                    tabs.innerHTML += `
                        <li class="nav-item" role="presentation">
                            <button class="nav-link ${isActive}" id="${month}-tab" data-bs-toggle="tab" data-bs-target="#${month}" type="button" role="tab" aria-controls="${month}" aria-selected="${index === 0}">${month}</button>
                            <button class="btn btn-danger btn-sm ms-2" onclick="deleteMonth('${month}')">Delete Month</button>
                        </li>
                    `;
                    
                    const monthData = wageData[month];
                    if (!Array.isArray(monthData)) {
                        console.error('Invalid month data:', month, monthData);
                        return;
                    }

                    let totalMonthWage = 0;
                    const sourcesHTML = monthData.map(source => {
                        if (!source.name || typeof source.baseWage !== 'number') {
                            console.error('Invalid source data:', source);
                            return '';
                        }

                        const shiftTotal = Array.isArray(source.shifts)
                            ? source.shifts.reduce((sum, shift) => sum + (shift.isExtra ? shift.amount : -shift.amount), 0)
                            : 0;
                        const sourceTotal = source.baseWage + shiftTotal;
                        totalMonthWage += sourceTotal;

                        const shiftsHTML = Array.isArray(source.shifts) ? source.shifts.map((shift, idx) => `
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ${shift.date} - ${shift.isExtra ? '+' : '-'} ${shift.amount.toFixed(2)} BRL
                                <button class="btn btn-danger btn-sm" onclick="deleteShift('${month}', '${escapeHtml(source.name)}', ${idx})">Delete</button>
                            </li>
                        `).join('') : '';

                        return `
                            <div class="card source-card">
                                <div class="card-body">
                                    <h5 class="card-title">${escapeHtml(source.name)}</h5>
                                    <p class="card-text">Base Wage: ${source.baseWage.toFixed(2)} BRL</p>
                                    <p class="card-text">Net Shifts: ${shiftTotal.toFixed(2)} BRL</p>
                                    <p class="card-text">Total: ${sourceTotal.toFixed(2)} BRL</p>
                                    <ul class="list-group shift-list">${shiftsHTML}</ul>
                                    <button class="btn btn-primary mt-2" onclick="openShiftModal('${month}', '${escapeHtml(source.name)}')">Add Shift</button>
                                </div>
                            </div>
                        `;
                    }).filter(Boolean).join('');

                    content.innerHTML += `
                        <div class="tab-pane fade ${isActive} ${isShow}" id="${month}" role="tabpanel" aria-labelledby="${month}-tab">
                            <h3>Total Wage: ${totalMonthWage.toFixed(2)} BRL</h3>
                            ${sourcesHTML || '<p>No wage sources added for this month. <button class="btn btn-primary btn-sm" onclick="openAddSourceModal(\'' + month + '\')">Add Source</button></p>'}
                        </div>
                    `;
                });

                if (months.length > 0) {
                    const firstTab = new bootstrap.Tab(document.querySelector('#monthTabs .nav-link'));
                    firstTab.show();
                }
            } catch (error) {
                console.error('Error rendering tabs:', error);
                document.getElementById('monthTabContent').innerHTML = '<p>Error loading data. Check console for details.</p>';
            }
        }

        function openAddSourceModal(monthYear) {
            document.getElementById('addSourceModal').dataset.month = monthYear;
            document.getElementById('sourceInputs').innerHTML = `
                <div class="mb-3">
                    <label for="sourceName1" class="form-label">Source Name</label>
                    <input type="text" class="form-control source-name" id="sourceName1" placeholder="e.g., Hospital A" required>
                </div>
                <div class="mb-3">
                    <label for="baseWage1" class="form-label">Base Wage (BRL)</label>
                    <input type="number" class="form-control base-wage" id="baseWage1" step="0.01" min="0" required>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('addSourceModal')).show();
        }

        function openShiftModal(monthYear, sourceName) {
            try {
                const modal = document.getElementById('addShiftModal');
                if (!modal) throw new Error('Shift modal not found');
                
                modal.dataset.month = monthYear;
                const sourceSelect = document.getElementById('shiftSource');
                if (!sourceSelect) throw new Error('Source select element not found');

                const monthData = wageData[monthYear];
                if (!monthData) throw new Error('Month data not found: ' + monthYear);

                sourceSelect.innerHTML = monthData.map(s => `
                    <option value="${escapeHtml(s.name)}" ${s.name === sourceName ? 'selected' : ''}>${escapeHtml(s.name)}</option>
                `).join('');
                new bootstrap.Modal(modal).show();
            } catch (error) {
                console.error('Error opening shift modal:', error);
            }
        }

        window.onload = renderTabs;
    </script>
</body>
</html>
