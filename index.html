<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wage Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .tab-content { margin-top: 20px; }
        .source-card { margin-bottom: 15px; }
        .shift-list { max-height: 200px; overflow-y: auto; }
        .total-wage { font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Wage Tracker</h1>
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addMonthModal">Add Month</button>
        
        <!-- Nav Tabs for Months -->
        <ul class="nav nav-tabs" id="monthTabs" role="tablist"></ul>
        <div class="tab-content" id="monthTabContent"></div>
    </div>

    <!-- Add Month Modal -->
    <div class="modal fade" id="addMonthModal" tabindex="-1" aria-labelledby="addMonthModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMonthModalLabel">Add Month</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="monthYear" class="form-label">Month (YYYY-MM)</label>
                        <input type="month" class="form-control" id="monthYear" required>
                    </div>
                    <div id="wageSources"></div>
                    <button type="button" class="btn btn-secondary" onclick="addSourceInput()">Add Another Source</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMonth()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Shift Modal -->
    <div class="modal fade" id="addShiftModal" tabindex="-1" aria-labelledby="addShiftModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addShiftModalLabel">Add Shift</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="shiftSource" class="form-label">Wage Source</label>
                        <select class="form-control" id="shiftSource"></select>
                    </div>
                    <div class="mb-3">
                        <label for="shiftDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="shiftDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="shiftAmount" class="form-label">Amount (BRL)</label>
                        <input type="number" class="form-control" id="shiftAmount" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="shiftType" class="form-label">Shift Type</label>
                        <select class="form-control" id="shiftType">
                            <option value="extra">Extra Shift (+)</option>
                            <option value="given">Given Shift (-)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveShift()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let wageData = JSON.parse(localStorage.getItem('wageData')) || {};

        function addSourceInput(name = '', wage = '') {
            const sourcesDiv = document.getElementById('wageSources');
            const count = sourcesDiv.children.length + 1;
            const div = document.createElement('div');
            div.className = 'source-input mb-3';
            div.innerHTML = `
                <label for="sourceName${count}" class="form-label">Source Name</label>
                <input type="text" class="form-control source-name" id="sourceName${count}" placeholder="e.g., Hospital A" value="${name}" required>
                <label for="baseWage${count}" class="form-label">Base Wage (BRL)</label>
                <input type="number" class="form-control base-wage" id="baseWage${count}" step="0.01" min="0" value="${wage}" required>
            `;
            sourcesDiv.appendChild(div);
        }

        function populatePreviousSources() {
            const sourcesDiv = document.getElementById('wageSources');
            sourcesDiv.innerHTML = '';
            const months = Object.keys(wageData).sort().reverse();
            if (months.length > 0) {
                const latestMonth = months[0];
                wageData[latestMonth].forEach(source => addSourceInput(source.name, source.baseWage));
            } else {
                addSourceInput();
            }
        }

        function saveMonth() {
            const monthYear = document.getElementById('monthYear').value;
            if (!monthYear) return alert('Please select a month.');
            
            const sources = [];
            const sourceInputs = document.querySelectorAll('.source-input');
            for (let input of sourceInputs) {
                const name = input.querySelector('.source-name').value;
                const wage = parseFloat(input.querySelector('.base-wage').value);
                if (name && !isNaN(wage)) {
                    sources.push({ name, baseWage: wage, shifts: [] });
                }
            }
            if (sources.length === 0) return alert('Please add at least one valid source.');

            wageData[monthYear] = sources;
            saveData();
            renderTabs();
            bootstrap.Modal.getInstance(document.getElementById('addMonthModal')).hide();
            populatePreviousSources();
        }

        function saveShift() {
            const monthYear = document.getElementById('addShiftModal').dataset.month;
            const sourceName = document.getElementById('shiftSource').value;
            const date = document.getElementById('shiftDate').value;
            const amount = parseFloat(document.getElementById('shiftAmount').value);
            const isExtra = document.getElementById('shiftType').value === 'extra';
            
            if (!date || isNaN(amount)) return alert('Please fill in all fields correctly.');

            const source = wageData[monthYear].find(s => s.name === sourceName);
            if (source) {
                source.shifts.push({ date, amount, isExtra });
                saveData();
                renderTabs();
                bootstrap.Modal.getInstance(document.getElementById('addShiftModal')).hide();
            }
        }

        function deleteShift(monthYear, sourceName, shiftIndex) {
            wageData[monthYear].find(s => s.name === sourceName).shifts.splice(shiftIndex, 1);
            saveData();
            renderTabs();
        }

        function saveData() {
            localStorage.setItem('wageData', JSON.stringify(wageData));
        }

        function renderTabs() {
            const tabs = document.getElementById('monthTabs');
            const content = document.getElementById('monthTabContent');
            tabs.innerHTML = '';
            content.innerHTML = '';

            const months = Object.keys(wageData).sort().reverse();
            months.forEach((month, index) => {
                const isActive = index === 0 ? 'active' : '';
                tabs.innerHTML += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ${isActive}" id="${month}-tab" data-bs-toggle="tab" data-bs-target="#${month}" type="button" role="tab" aria-controls="${month}" aria-selected="${index === 0}">${month}</button>
                    </li>
                `;
                
                let totalMonthWage = 0;
                const sourcesHTML = wageData[month].map(source => {
                    const shiftTotal = source.shifts.reduce((sum, shift) => sum + (shift.isExtra ? shift.amount : -shift.amount), 0);
                    const sourceTotal = source.baseWage + shiftTotal;
                    totalMonthWage += sourceTotal;
                    
                    const shiftsHTML = source.shifts.map((shift, idx) => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${shift.date} - ${shift.isExtra ? '+' : '-'} ${shift.amount.toFixed(2)} BRL
                            <button class="btn btn-danger btn-sm" onclick="deleteShift('${month}', '${source.name}', ${idx})">Delete</button>
                        </li>
                    `).join('');
                    
                    return `
                        <div class="card source-card">
                            <div class="card-body">
                                <h5 class="card-title">${source.name}</h5>
                                <p class="card-text">Base Wage: ${source.baseWage.toFixed(2)} BRL</p>
                                <p class="card-text">Net Shifts: ${shiftTotal.toFixed(2)} BRL</p>
                                <p class="card-text">Total: ${sourceTotal.toFixed(2)} BRL</p>
                                <ul class="list-group shift-list">${shiftsHTML}</ul>
                                <button class="btn btn-primary mt-2" onclick="openShiftModal('${month}', '${source.name}')">Add Shift</button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                content.innerHTML += `
                    <div class="tab-pane fade ${isActive}" id="${month}" role="tabpanel" aria-labelledby="${month}-tab">
                        <h3>Total Wage: ${totalMonthWage.toFixed(2)} BRL</h3>
                        ${sourcesHTML}
                    </div>
                `;
            });
        }

        function openShiftModal(monthYear, sourceName) {
            const modal = document.getElementById('addShiftModal');
            modal.dataset.month = monthYear;
            const sourceSelect = document.getElementById('shiftSource');
            sourceSelect.innerHTML = wageData[monthYear].map(s => `<option value="${s.name}" ${s.name === sourceName ? 'selected' : ''}>${s.name}</option>`).join('');
            new bootstrap.Modal(modal).show();
        }

        // Initialize sources when modal is shown
        document.getElementById('addMonthModal').addEventListener('show.bs.modal', populatePreviousSources);

        window.onload = renderTabs;
    </script>
</body>
</html>
