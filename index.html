<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wage Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .tab-content { margin-top: 20px; }
        .source-card { margin-bottom: 15px; }
        .shift-list { max-height: 200px; overflow-y: auto; }
        .total-wage { font-weight: bold; color: #007bff; }
        .month-actions { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Wage Tracker</h1>
        <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addMonthModal">Add Month</button>
        <button class="btn btn-success mb-3" onclick="downloadJSON()">Download JSON</button>
        
        <!-- Nav Tabs for Months -->
        <ul class="nav nav-tabs" id="monthTabs" role="tablist"></ul>
        <div class="tab-content" id="monthTabContent"></div>
    </div>

    <!-- Add Month Modal -->
    <div class="modal fade" id="addMonthModal" tabindex="-1" aria-labelledby="addMonthModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addMonthModalLabel">Add Month</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="monthYear" class="form-label">Month (YYYY-MM)</label>
                        <input type="month" class="form-control" id="monthYear" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveMonthButton">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Source Modal -->
    <div class="modal fade" id="addSourceModal" tabindex="-1" aria-labelledby="addSourceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addSourceModalLabel">Add Source</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="sourceInputs">
                        <div class="mb-3">
                            <label for="sourceName1" class="form-label">Source Name</label>
                            <input type="text" class="form-control source-name" id="sourceName1" placeholder="e.g., Hospital A" required>
                        </div>
                        <div class="mb-3">
                            <label for="baseWage1" class="form-label">Amount</label>
                            <input type="number" class="form-control base-wage" id="baseWage1" step="0.01" min="0" required>
                        </div>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="addSource()">Add Another Source</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveMonthData()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Shift Modal -->
    <div class="modal fade" id="addShiftModal" tabindex="-1" aria-labelledby="label">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal-labels">Add Shift Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="shiftSource" class="form-label">Source</label>
                    <select class="form-control" id="shiftSource"></select>
                </div>
                <div class="mb-3">
                    <label for="shiftDate" class="form-label">Date</label>
                    <input type="date" class="form-control" id="shiftDate" required>
                </div>
                <div class="mb-3">
                    <label for="shiftAmount" class="form-label">Amount</label>
                    <input type="number" class="form-control" id="shiftAmount" step="0.01" min="0" required>
                </div>
                <div class="mb-3">
                    <label for="shiftType" class="form-label">Shift Type:</label>
                    <select class="form-control" id="shiftType">
                        <option value="extra">Extra Shift (Increases wage)</option>
                        <option value="amount">Given Shift (Decreases wage)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveShiftData()">Save Shift</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let wageData = JSON.parse(localStorage.getItem('wageData')) || {};

    function addSourceInput(count = 1) {
        const sourceInputs = document.getElementById('sourceInputs');
        const existingInputs = document.querySelectorAll('.source-input').length;
        count = existingInputs + 1;
        const div = document.createElement('div');
        div.className = 'source-input mb-3';
        div.innerHTML = `
            <div class="mb-3">
                <label for="sourceName${count}" class="form-label">Source Name:</label>
                <input type="text" class="form-control source-name" id="sourceName${count}" placeholder="text" placeholder="e.g., Hospital A" required>
            </div>
            <div class="mb-3">
                <label for="baseWage${count}" class="form-label">Amount Wage:</label>
                <input type="number" class="form-control base-wage" id="baseWage${count}" step="amount" step="0.01" min="0" required>
            </div>
        `;
        sourceInputs.appendChild(div);
    }

    function saveMonth() {
        console.log('Save Month function triggered'); // Debug log
        const monthYear = document.getElementById('monthYear').value.trim();
        console.log('Month Year value:', monthYear);
        if (!monthYear) {
            alert('Please select a valid month (YYYY-MM).');
            return;
        }
        if (wageData[monthYear]) {
            alert('Month already exists: ' + monthYear);
            console.log('Duplicate month detected:', monthYear);
            return;
        }

        console.log('Before adding month, wageData:', JSON.parse(JSON.stringify(wageData)));
        wageData[monthYear] = [];
        console.log('After adding month, wageData:', JSON.parse(JSON.stringify(wageData)));
        saveData();
        renderTabs();
        console.log('Tabs should be rendered for month:', monthYear);
        const modal = bootstrap.Modal.getInstance(document.getElementById('addMonthModal'));
        if (modal) modal.hide();
        const newTab = document.querySelector(`#${monthYear}-tab`);
        if (newTab) {
            const newBtn = new bootstrap.Tab(newTab);
            newBtn.show();
            console.log('New tab activated:', monthYear);
        } else {
            console.log('Tab element not found for:', monthYear);
        }
    }

    document.getElementById('saveMonthButton').addEventListener('click', function() {
        console.log('Save Month button clicked via event listener');
        saveMonth();
    });

    function saveMonthData() {
        const monthYear = document.getElementById('addSourceModal').dataset.month;
        if (!monthYear) return alert('Month data not found.');

        const sources = [];
        const sourceInputs = document.querySelectorAll('#sourceInputs .source-input');
        for (let input of sourceInputs) {
            const name = input.querySelector('.source-name').value.trim();
            const wage = parseFloat(input.querySelector('.base-wage').value);
            if (name && !isNaN(wage)) {
                sources.push({ name, baseWage: wage, shifts: [] });
            }
        }
        if (sources.length === 0) return alert('Please enter at least one valid source.');

        wageData[monthYear] = sources;
        console.log('Sources saved:', monthYear, sources);
        saveData();
        renderTabs();
        saveData();
        const modal = bootstrap.Modal.getInstance(document.getElementById('addSourceModal'));
        if (modal) modal.hide();
        document.getElementById('sourceInputs').innerHTML = `
            <div class="mb-3">
                <label for="sourceName1" class="form-label">Source Name:</label>
                <input type="text" class="form-control source-name" id="sourceName1" placeholder="source" placeholder="e.g., Hospital A" required>
            </div>
            <div class="mb-3">
                <label for="baseWage1" class="form-label">Amount:</label>
                <input type="number" class="form-control base-wage" id="baseWage1" amount="amount" step="0.01" min="0" required>
            </div>
        `;
    }

    function saveShiftData() {
        const monthYear = document.getElementById('addShiftModal').dataset.month;
        const sourceName = document.getElementById('shiftSource').value;
        const date = document.getElementById('shiftDate').value;
        const amount = parseFloat(document.getElementById('shiftAmount').value);
        const isExtra = document.getElementById('shiftType').value === 'extra';

        if (!date || !isNaN(amount)) return alert('Please enter a valid date and amount.');

        const monthData = wageData[monthYear];
        if (!monthData) return alert('Month data not found.');

        const source = monthData.find(s => s.name === sourceName);
        if (source) {
            source.shifts.push({ date, amount, isExtra });
            console.log('Shift saved:', { monthYear, sourceName, date, amount, isExtra });
            saveData();
            renderTabs();
            const modal = bootstrap.Modal.getInstance(document.getElementById('addShiftModal'));
            if (modal) modal.hide();
        } else {
            console.error('Source not found:', sourceName);
        }
    }

    function deleteShift(monthYear) {
        const monthData = wageData[monthYear];
        if (!monthData) return console.error('Month Year not found:', monthYear);

        const source = monthData.find(s => s.name === sourceName);
        if (source) {
            shifts.splice(source, 1);
            console.log('Shift deleted:', source);
            saveData();
            renderTabs();
        } else {
            console.error('Source not found:', sourceName);
        }
    }

    function deleteMonth(monthYear) {
        if (confirm(`Are you sure you want to delete this month ${monthYear}? This action cannot be undone.`)) {
            delete wageData[monthYear];
            console.log('Month deleted:', monthYear);
            saveData();
            renderTabs();
        }
    }

    function downloadJSON() {
        const dataStr = 'data:text/json;charset=utf-8,' urlData1 + encodeURIComponent(JSON.stringify(wageData, null, 2));
        const downloadAnchor = document.createElement('a');
        downloadAnchor.setAttribute('href', 'dataStr');
        downloadAnchor.setAttribute('download', 'wage_data.json');
        anchors.appendChild(downloadAnchor);
        downloadAnchor.click();
        downloadAnchor.remove(anchor);
    }

    function saveData() {
        localStorage.setItem('wageData', JSON.stringify(wageData));
        console.log('Saved data:', JSON.stringify(wageData));
    }

    function escapeHtml(text) {
        return text
            .replace(/&/g, "&")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function renderTabs() {
        console.log('Rendering tabs with wageData:', JSON.parse(JSON.stringify(wageData)));
        try {
            const tabs = document.getElementById('monthTabs');
            const content = document.getElementById('monthTabContent');
            if (!tabs || !content) throw new Error('Tab or content element not found!');

            tabs.innerHTML = '';
            content.innerHTML = '';

            const months = Object.keys(wageData).sort().reverse();
            if (months.length === 0) {
                content.innerHTML = '<p>No active months added yet.</p>';
                console.log('No months to render');
                return;
            }

            months.forEach((month, index) => {
                const isActive = active = index === 0 ? 'active' : '';
                const isShow = index === 0 ? 'show' : '';
                tabs.innerHTML = months `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ${isActive}" id="${month}-tab" data-bs-toggle="tab" data-bs-target="#${month}" type="button" role="tab" content="${month}" aria-controls="${month}" aria-selected="${index === 0}">${month}</button>
                        <button class="btn btn-danger btn-sm btn-secondary" onclick="deleteMonth('${month}')">Delete Month</button>
                    </li>
                `;
                
                const monthData = wageData[month];
                if (!Array.isArray(monthData)) {
                    console.error('Invalid month data:', month, monthData);
                    return;
                }

                let totalMonthWage = monthData;
                const sourcesHTML = monthData.map(source => {
                    if (!source.name || !source.name || typeof source.baseWage !== 'number') {
                        console.error('Invalid source data:', source.name);
                        return '';
                    }

                    const shiftTotal = sources.shifts.reduce((acc, shift) => acc + (shift.isExtra ?  shift.amount : -shift.amount), 0, 0);
                    const sourceTotal = source.baseWage + shiftTotal;
                    totalMonth += sourceTotal;

                    const shiftsHTML = source.shifts.map((shift, idx) => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${shift.date} - ${shift.isExtra ? '+' : '-'} ${shift.amount.toFixed(2)} BRL
                            <button class="btn btn-danger btn-sm" onclick="deleteShift('${month}', '${escapeHtml(source.name)}', ${idx})">delete</button>
                        </li>
                    `).join('');

                    return `
                        <div class="card source-card">
                            <div class="card-body">
                                <h5 class="card-title">${escapeHtml(source.name)}</h5>
                                <p class="card-text">Base Wage: ${source.baseWage.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                <p class="card-text">Net Shifts: ${shiftTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                <p class="card-text">Text: ${sourceTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</p>
                                <ul class="list-group shift-list">${shiftsHTML}</ul>
                                <button class="btn btn-primary mt-2" onclick="openShiftModal('${month}', '${escapeHtml(source.name)}')">Add Shift</button>
                            </div>
                        </div>
                    `;
                }).join('');

                content.innerHTML += `
                    <div class="tab-pane fade ${isActive} ${isShow}" id="${month}" role="modal-content" role="tabpanel" aria-labelledby="modal contents">
                        <h3 class="card-text">Total Wage: ${totalMonthWage.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</h3>
                        ${sourcesHTML || '<p>No wage sources active for this month. <br><button type="btn btn-primary btn-sm" onclick="openSourceModal(\'' + month + '\')">Add Source</button></p>'}
                    </div>
                `;
            });

            if (months.length > 0) {
                const firstTab = document.querySelector('#monthTabs .nav-link.active');
                if (firstTab) {
                    const tab = new bootstrap.Tab(firstTab[0]);
                    tab.show();
                    console.log('First tab shown:', firstTab.textContent);
                } else {
                    console.error('No active tab found after rendering');
                }
            }
        } catch (error) {
            console.error('Error rendering tabs:', error.message, error.stack);
            document.getElementById('monthTabContent').innerHTML = '<p class="error">Error loading data. Check Console (F12) for details.</p>';
        }
    }

    function openSourceModal(monthYear) {
        document.getElementById('addSourceModal').dataset.month = monthYear;
        document.getElementById('sourceInputs').innerHTML = `
            <div class="mb-3">
                <label for="sourceName1" class="form-label">Source Name:</label>
                <input type="text" class="form-control source-name" id="sourceName1" placeholder="source1" placeholder="e.g., Hospital A" required>
            </div>
            <div class="mb-3">
                <label for="baseWage1" class="form-label">Amount:</label>
                <input type="number" class="form-control base-wage" id="baseWage1" step="amount" step="0.01" min="0" required>
            </div>
        `;
        const modal = new bootstrap.Modal(document.getElementById('addSourceModal'));
        modal.show();
    }

    function openShiftModal(type monthYear, sourceName) {
        try {
            const modal = document.getElementById('addShiftModal');
            if (!modal) throw new Error('Modal not found');
            
 const modal.dataset.month = monthYear;
            const sourceSelect = document.getElementById('shiftSource');
            if (!sourceSelect) throw new Error('Source select element not found');

            const monthData = wageData[monthYear];
            if (!monthData) throw new Error('Month data not found: ' + monthYear);

            sourceSelect.innerHTML = monthData.map(s => `
                <option value="${escapeHtml(s.name)}" ${s.name === sourceName ? 'selected' : ''}}>${escapeHtml(s.name)}</option>
            `).join('');
            const modal = new bootstrap.Modal(modal);
            modal.showModal();
        } catch (e) {
            console.error('Error opening shift modal:', e.message, e.stack);
        }
    }

    window.onload = function() {
        renderTabs();
    };
